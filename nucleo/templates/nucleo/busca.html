{% extends 'nucleo/base.html' %}

{% block title %}Resultados da Pesquisa - NerdHub{% endblock %}

{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/style_busca.css' %}">

<div class="main-content">
    <!-- Search Results Header -->
    <section class="search-results-header">
        <h1 class="search-results-title">
            <i class="fas fa-search"></i>
            Resultados para: <span class="search-term">"{{ termo_busca }}"</span>
        </h1>
        <p class="results-count">Encontramos <strong>{{ total_resultados }} produtos</strong> relacionados com sua pesquisa</p>
    </section>

    <!-- Filters Section -->
    <section class="filters-section">
        <div class="filters-header">
            <h2 class="filters-title">
                <i class="fas fa-filter"></i>
                Filtrar Resultados
            </h2>
            <button class="clear-filters-btn" onclick="limparFiltros()">
                <i class="fas fa-redo"></i>
                Limpar filtros
            </button>
        </div>
        
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">Ordenar por:</label>
                <select class="filter-select" id="ordenarPor" onchange="aplicarFiltros()">
                    <option value="relevancia" {% if filtros_aplicados.ordenar_por == 'relevancia' %}selected{% endif %}>Mais relevantes</option>
                    <option value="preco_asc" {% if filtros_aplicados.ordenar_por == 'preco_asc' %}selected{% endif %}>Menor preço</option>
                    <option value="preco_desc" {% if filtros_aplicados.ordenar_por == 'preco_desc' %}selected{% endif %}>Maior preço</option>
                    <option value="nome" {% if filtros_aplicados.ordenar_por == 'nome' %}selected{% endif %}>Nome (A-Z)</option>
                    <option value="mais_recentes" {% if filtros_aplicados.ordenar_por == 'mais_recentes' %}selected{% endif %}>Mais recentes</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Faixa de preço:</label>
                <div class="price-range-inputs">
                    <input type="number" class="price-input" id="precoMin" placeholder="Min" value="{{ filtros_aplicados.preco_min|default:'' }}" onchange="aplicarFiltros()">
                    <span class="price-separator">-</span>
                    <input type="number" class="price-input" id="precoMax" placeholder="Max" value="{{ filtros_aplicados.preco_max|default:'' }}" onchange="aplicarFiltros()">
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Marca:</label>
                <select class="filter-select" id="marca" onchange="aplicarFiltros()">
                    <option value="">Todas as marcas</option>
                    {% for marca in marcas %}
                    <option value="{{ marca.id }}" {% if filtros_aplicados.marca == marca.id|stringformat:"s" %}selected{% endif %}>{{ marca.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Categoria:</label>
                <select class="filter-select" id="categoria" onchange="aplicarFiltros()">
                    <option value="">Todas as categorias</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.id }}" {% if filtros_aplicados.categoria == categoria.id|stringformat:"s" %}selected{% endif %}>{{ categoria.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </section>

    <!-- Products Grid -->
    <div class="products-grid-section">
        {% if produtos %}
        <div class="products-grid-container" id="productsGrid">
            {% for produto in produtos %}
            <article class="product-card">
                <div class="product-card-header">
                    {% with days_since_creation=produto.criado_em|timesince %}
                    {% if days_since_creation.days < 30 %}
                    <div class="product-badges">
                        <span class="product-badge badge-new">NOVO</span>
                    </div>
                    {% endif %}
                    {% endwith %}
                    <div class="product-image-container">
                        <img src="{{ produto.imagem_principal.url }}" alt="{{ produto.nome }}" class="product-image">
                    </div>
                </div>
                
                {% if produto.marca %}
                <div class="brand-info">
                    {% if produto.marca.logo %}
                    <img src="{{ produto.marca.logo.url }}" alt="{{ produto.marca.nome }}" class="brand-logo">
                    {% endif %}
                    <span class="brand-name">{{ produto.marca.nome }}</span>
                </div>
                {% endif %}
                
                <h3 class="product-title">{{ produto.nome }}</h3>
                
                <!-- Product Rating (if reviews exist) -->
                {% if produto.reviews.exists %}
                <div class="product-rating">
                    <div class="stars">
                        {% with produto.media_avaliacoes as media %}
                        {% for i in "12345" %}
                        {% if forloop.counter <= media|floatformat:"0"|add:"0" %}
                        <i class="fas fa-star star"></i>
                        {% else %}
                        <i class="far fa-star star empty"></i>
                        {% endif %}
                        {% endfor %}
                        {% endwith %}
                    </div>
                    <span class="rating-value">{{ produto.media_avaliacoes|floatformat:1 }}</span>
                    <span class="rating-count">({{ produto.reviews.count }})</span>
                </div>
                {% endif %}
                
                <div class="product-pricing">
                    <span class="current-price">R$ {{ produto.preco|floatformat:2 }}</span>
                    {% widthratio produto.preco 12 1 as parcela_valor %}
                    <span class="installments">12x R$ {{ parcela_valor|floatformat:2 }}</span>
                </div>
                
                <div class="product-actions">
                    <form method="post" action="{% url 'nucleo:adicionar_ao_carrinho' produto.id %}">
                        {% csrf_token %}
                        <button type="submit" class="add-to-cart-btn" data-product="{{ produto.id }}">
                            <i class="fas fa-cart-plus"></i>
                            Comprar
                        </button>
                    </form>
                    <button class="wishlist-btn" aria-label="Adicionar aos favoritos">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <!-- No Results -->
        <div class="no-results">
            <i class="fas fa-search no-results-icon"></i>
            <h3 class="no-results-title">Nenhum produto encontrado</h3>
            <p class="no-results-message">Não encontramos nenhum produto correspondente à sua busca "{{ termo_busca }}".</p>
            
            <div class="suggestions">
                <h4 class="suggestions-title">Tente:</h4>
                <div class="suggestions-list">
                    <span class="suggestion-tag" onclick="buscarTermo('controle')">controle</span>
                    <span class="suggestion-tag" onclick="buscarTermo('jogo')">jogo</span>
                    <span class="suggestion-tag" onclick="buscarTermo('console')">console</span>
                    <span class="suggestion-tag" onclick="buscarTermo('acessório')">acessório</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Apply filters function
    function aplicarFiltros() {
        // Get current URL and parameters
        const urlParams = new URLSearchParams(window.location.search);
        const baseUrl = window.location.pathname;
        
        // Get filter values
        const termoBusca = urlParams.get('q') || '';
        const ordenarPor = document.getElementById('ordenarPor').value;
        const precoMin = document.getElementById('precoMin').value;
        const precoMax = document.getElementById('precoMax').value;
        const marca = document.getElementById('marca').value;
        const categoria = document.getElementById('categoria').value;
        
        // Build new URL with filters
        const newParams = new URLSearchParams();
        if (termoBusca) newParams.set('q', termoBusca);
        if (ordenarPor && ordenarPor !== 'relevancia') newParams.set('ordenar_por', ordenarPor);
        if (precoMin) newParams.set('preco_min', precoMin);
        if (precoMax) newParams.set('preco_max', precoMax);
        if (marca) newParams.set('marca', marca);
        if (categoria) newParams.set('categoria', categoria);
        
        // Redirect to new URL
        window.location.href = `${baseUrl}?${newParams.toString()}`;
    }
    
    // Clear filters function
    function limparFiltros() {
        const urlParams = new URLSearchParams(window.location.search);
        const termoBusca = urlParams.get('q') || '';
        
        // Keep only the search term
        const newParams = new URLSearchParams();
        if (termoBusca) newParams.set('q', termoBusca);
        
        window.location.href = `${window.location.pathname}?${newParams.toString()}`;
    }
    
    // Search suggestion function
    function buscarTermo(termo) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('q', termo);
        window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
    }
    
    // Add to cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            const originalText = this.innerHTML;
            
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando...';
            this.disabled = true;
            
            // Submit form via AJAX
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart count in header
                    const cartCount = document.querySelector('.cart-count');
                    if (cartCount) {
                        cartCount.textContent = data.cart_count;
                    }
                    
                    // Show success feedback
                    this.innerHTML = '<i class="fas fa-check"></i> Adicionado';
                    this.style.backgroundColor = 'var(--primary-dark)';
                    
                    // Show notification
                    showNotification(data.message || 'Produto adicionado ao carrinho!');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                        this.style.backgroundColor = '';
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Erro ao adicionar produto ao carrinho');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = originalText;
                this.disabled = false;
                alert('Erro ao adicionar produto ao carrinho. Por favor, tente novamente.');
            });
        });
    });
    
    // Wishlist functionality
    document.querySelectorAll('.wishlist-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const heartIcon = this.querySelector('i');
            if (heartIcon.classList.contains('fas')) {
                // Already favorited - remove
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
                showNotification('Produto removido dos favoritos!');
            } else {
                // Not favorited - add
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
                showNotification('Produto adicionado aos favoritos!');
            }
        });
    });
    
    // Notification function
    function showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
            font-weight: 600;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Entrance animation
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 10);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}